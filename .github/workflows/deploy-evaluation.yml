name: WYDOT RAG Evaluation Job Deployment

on:
  push:
    branches: [ main ]
    paths:
      - "evaluation/**"
      - ".github/workflows/deploy-evaluation.yml"
  workflow_dispatch:
  schedule:
    # Run weekly evaluation on Sundays at midnight UTC
    - cron: '0 0 * * 0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT }}
      REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
      IMAGE: us-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/apps/wydot-evaluation:latest
      JOB_NAME: wydot-rag-evaluation

    steps:
    - uses: actions/checkout@v4

    - id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: github-actions-sa@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com

    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT }}

    - name: Configure Docker
      run: gcloud auth configure-docker us-docker.pkg.dev --quiet

    # Create evaluation results bucket
    - name: Create GCS bucket for evaluations
      run: |
        BUCKET=wydot-evaluations-${PROJECT_ID}
        if ! gsutil ls gs://${BUCKET} 2>/dev/null; then
          gsutil mb -l ${REGION} gs://${BUCKET}
        fi

    # Build and push image
    - name: Build & push image
      run: |
        docker build -t "${IMAGE}" ./evaluation
        docker push "${IMAGE}"

    # Deploy as Cloud Run Job
    - name: Deploy Cloud Run Job
      run: |
        gcloud run jobs create ${JOB_NAME} \
          --image=${IMAGE} \
          --region=${REGION} \
          --project=${PROJECT_ID} \
          --service-account=cloud-run-sa@${PROJECT_ID}.iam.gserviceaccount.com \
          --cpu=2 \
          --memory=4Gi \
          --task-timeout=30m \
          --max-retries=1 \
          --set-env-vars="GCS_EVAL_BUCKET=wydot-evaluations-${PROJECT_ID}" \
          --set-env-vars="EVAL_SOURCE=synthetic" \
          --set-env-vars="NUM_SYNTHETIC=10" \
          --set-secrets="NEO4J_URI=neo4j-uri:latest" \
          --set-secrets="NEO4J_USERNAME=neo4j-username:latest" \
          --set-secrets="NEO4J_PASSWORD=neo4j-password:latest" \
          --set-secrets="GCP_PROJECT_ID=gcp-project-id:latest" \
          2>/dev/null || \
        gcloud run jobs update ${JOB_NAME} \
          --image=${IMAGE} \
          --region=${REGION} \
          --project=${PROJECT_ID}

    # Create Cloud Scheduler job for weekly runs
    - name: Create scheduled trigger
      run: |
        SCHEDULER_NAME="${JOB_NAME}-weekly"
        
        gcloud scheduler jobs create http ${SCHEDULER_NAME} \
          --location=${REGION} \
          --schedule="0 0 * * 0" \
          --uri="https://${REGION}-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/${PROJECT_ID}/jobs/${JOB_NAME}:run" \
          --http-method=POST \
          --oauth-service-account-email=cloud-run-sa@${PROJECT_ID}.iam.gserviceaccount.com \
          --project=${PROJECT_ID} \
          2>/dev/null || echo "Scheduler job already exists"

    - name: Execution info
      run: |
        echo "üöÄ Evaluation job deployed: ${JOB_NAME}"
        echo "üìä Results bucket: gs://wydot-evaluations-${PROJECT_ID}/"
        echo "‚è∞ Scheduled weekly on Sundays at midnight UTC"
        echo ""
        echo "To run manually:"
        echo "  gcloud run jobs execute ${JOB_NAME} --region=${REGION}"
