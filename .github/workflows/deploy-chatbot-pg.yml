name: Deploy Chatbot PostgreSQL Service to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'chatapp.py'
      - '.chainlit/**'
      - 'public/**'
      - 'utils/**'
      - 'cloudrun/chatbot-pg.yaml'
      - '.github/workflows/deploy-chatbot-pg.yml'
      - 'Dockerfile.chatbot'
      - 'requirements.txt'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT }}
  REGION: ${{ secrets.GCP_LOCATION || 'us-central1' }}
  GAR_LOCATION: us-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/apps

jobs:
  deploy-chatbot-pg:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: github-deployer@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: 'Docker Auth'
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: 'Ensure Cloud SQL Client role for Cloud Run SA'
        run: |-
          gcloud projects add-iam-policy-binding "${{ env.PROJECT_ID }}" \
            --member="serviceAccount:cloud-run-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com" \
            --role="roles/cloudsql.client" \
            --condition=None \
            --quiet || echo "⚠️ Could not grant cloudsql.client"

      - name: 'Build and Push Chatbot'
        run: |-
          docker build -f Dockerfile.chatbot -t "${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}"

      - name: 'Prepare Chatbot-PG YAML'
        run: |-
          IMAGE="${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}"
          sed -e "s|\${PROJECT_ID}|${{ env.PROJECT_ID }}|g" \
              -e "s|\${IMAGE}|${IMAGE}|g" \
              cloudrun/chatbot-pg.yaml > /tmp/chatbot-pg-deploy.yaml

      - name: 'Deploy Chatbot-PG'
        run: |-
          gcloud run services replace /tmp/chatbot-pg-deploy.yaml \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"

      - name: 'Allow Unauthenticated Access to Chatbot-PG'
        run: |-
          gcloud run services add-iam-policy-binding wydot-chatbot-pg \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --member="allUsers" \
            --role="roles/run.invoker"
