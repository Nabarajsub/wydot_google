name: Deploy PostgreSQL Services to Cloud Run

# This pipeline deploys wydot-chatbot-pg and wydot-admin-pg
# These are SEPARATE services from the existing wydot-chatbot and wydot-admin
# They use PostgreSQL (Cloud SQL) instead of SQLite

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT }}
  REGION: ${{ secrets.GCP_LOCATION || 'us-central1' }}
  GAR_LOCATION: us-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/apps

jobs:
  deploy-pg:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Authenticate using Workload Identity
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: github-deployer@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com

      # Set up gcloud CLI
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      # Authenticate Docker to Artifact Registry
      - name: 'Docker Auth'
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      # Grant Cloud SQL Client role to Cloud Run service account (idempotent)
      - name: 'Ensure Cloud SQL Client role for Cloud Run SA'
        run: |-
          gcloud projects add-iam-policy-binding "${{ env.PROJECT_ID }}" \
            --member="serviceAccount:cloud-run-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com" \
            --role="roles/cloudsql.client" \
            --condition=None \
            --quiet || echo "⚠️ Could not grant cloudsql.client (may already exist or insufficient permissions)"

      # 1. Build and Push Chatbot
      - name: 'Build and Push Chatbot'
        run: |-
          docker build -f Dockerfile.chatbot -t "${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}"

      # 2. Build and Push Admin
      - name: 'Build and Push Admin'
        run: |-
          docker build -f Dockerfile.admin -t "${{ env.GAR_LOCATION }}/wydot-admin:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/wydot-admin:${{ github.sha }}"

      # 3. Deploy Chatbot-PG via Knative YAML (PostgreSQL via Cloud SQL proxy)
      - name: 'Prepare Chatbot-PG YAML'
        run: |-
          IMAGE="${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}"
          sed -e "s|\${PROJECT_ID}|${{ env.PROJECT_ID }}|g" \
              -e "s|\${IMAGE}|${IMAGE}|g" \
              cloudrun/chatbot-pg.yaml > /tmp/chatbot-pg-deploy.yaml
          echo "=== Rendered Chatbot-PG YAML ==="
          cat /tmp/chatbot-pg-deploy.yaml

      - name: 'Deploy Chatbot-PG'
        run: |-
          gcloud run services replace /tmp/chatbot-pg-deploy.yaml \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"

      - name: 'Allow Unauthenticated Access to Chatbot-PG'
        run: |-
          gcloud run services add-iam-policy-binding wydot-chatbot-pg \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --member="allUsers" \
            --role="roles/run.invoker"

      # 4. Deploy Admin-PG via Knative YAML (PostgreSQL via Cloud SQL proxy)
      - name: 'Prepare Admin-PG YAML'
        run: |-
          IMAGE="${{ env.GAR_LOCATION }}/wydot-admin:${{ github.sha }}"
          sed -e "s|\${PROJECT_ID}|${{ env.PROJECT_ID }}|g" \
              -e "s|\${IMAGE}|${IMAGE}|g" \
              cloudrun/admin-pg.yaml > /tmp/admin-pg-deploy.yaml
          echo "=== Rendered Admin-PG YAML ==="
          cat /tmp/admin-pg-deploy.yaml

      - name: 'Deploy Admin-PG'
        continue-on-error: true
        run: |-
          gcloud run services replace /tmp/admin-pg-deploy.yaml \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"

      - name: 'Allow Unauthenticated Access to Admin-PG'
        continue-on-error: true
        run: |-
          gcloud run services add-iam-policy-binding wydot-admin-pg \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --member="allUsers" \
            --role="roles/run.invoker"
