name: metadata based Cloud Run Deployment

on:
  push:
    branches: [ main ]
    paths:
      - "llamacheck_metadata/app2.py"
      - "cloudrun/flash.yaml"
      - "requirements.txt"
      - "Dockerfile"
      - "entrypoint.py"
      - ".github/workflows/flash-cloud.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT }}
      REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
      IMAGE: us-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/apps/flash-cloud:latest
      APP_FILE: llamacheck_metadata/app2.py
      REQS_FILE: requirements.txt

    steps:
    - uses: actions/checkout@v4

    # ðŸ” Authenticate to Google Cloud
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: github-actions-sa@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com

    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-docker.pkg.dev --quiet

    - name: Build & push image
      run: |
        docker build \
          --build-arg APP_FILE="${APP_FILE}" \
          --build-arg REQS_FILE="${REQS_FILE}" \
          -t "${IMAGE}" .
        docker push "${IMAGE}"

    - name: Prepare YAML (inject project id)
      run: sed -e "s/\${PROJECT_ID}/${PROJECT_ID}/g" cloudrun/flash.yaml > /tmp/flash.yaml

    - name: Deploy to Cloud Run
      run: |
        set -x
        # Try to replace (update existing service)
        gcloud run services replace /tmp/flash.yaml --region="${REGION}" --project="${PROJECT_ID}" || \
        # Fall back to deploy if service doesn't exist
        gcloud run deploy metadatabased \
          --image us-docker.pkg.dev/${PROJECT_ID}/apps/flash-cloud:latest \
          --region "${REGION}" \
          --service-account cloud-run-sa@${PROJECT_ID}.iam.gserviceaccount.com \
          --allow-unauthenticated \
          --quiet

    - name: Make service public (optional safeguard)
      run: gcloud run services add-iam-policy-binding metadatabased --member="allUsers" --role="roles/run.invoker" --region="${REGION}" --project="${PROJECT_ID}"
#final deployments