name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT }}
  REGION: ${{ secrets.GCP_LOCATION || 'us-central1' }}
  GAR_LOCATION: us-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/apps

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Authenticate using Workload Identity
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: github-deployer@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com

      # Set up gcloud CLI (required for gcloud run services replace)
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      # Authenticate Docker to Artifact Registry
      - name: 'Docker Auth'
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet

      # 1. Build and Push Chatbot
      - name: 'Build and Push Chatbot'
        run: |-
          docker build -f Dockerfile.chatbot -t "${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}"

      # 2. Build and Push Admin
      - name: 'Build and Push Admin'
        run: |-
          docker build -f Dockerfile.admin -t "${{ env.GAR_LOCATION }}/wydot-admin:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/wydot-admin:${{ github.sha }}"

      # 3. Build and Push Embeddings (Vertex AI Image)
      - name: 'Build and Push Embeddings'
        run: |-
          docker build -t "${{ env.GAR_LOCATION }}/wydot-embeddings:${{ github.sha }}" ./deploy/embeddings
          docker push "${{ env.GAR_LOCATION }}/wydot-embeddings:${{ github.sha }}"

      # 4. Deploy Chatbot via Knative YAML (matches working flash-cloud pattern)
      - name: 'Prepare Chatbot YAML'
        run: |-
          IMAGE="${{ env.GAR_LOCATION }}/wydot-chatbot:${{ github.sha }}"
          sed -e "s|\${PROJECT_ID}|${{ env.PROJECT_ID }}|g" \
              -e "s|\${IMAGE}|${IMAGE}|g" \
              cloudrun/chatbot.yaml > /tmp/chatbot-deploy.yaml
          echo "=== Rendered YAML ==="
          cat /tmp/chatbot-deploy.yaml

      - name: 'Deploy Chatbot'
        run: |-
          gcloud run services replace /tmp/chatbot-deploy.yaml \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"

      - name: 'Allow Unauthenticated Access to Chatbot'
        run: |-
          gcloud run services add-iam-policy-binding wydot-chatbot \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --member="allUsers" \
            --role="roles/run.invoker"

      # 5. Deploy Admin via Knative YAML (matches chatbot pattern)
      - name: 'Prepare Admin YAML'
        run: |-
          IMAGE="${{ env.GAR_LOCATION }}/wydot-admin:${{ github.sha }}"
          sed -e "s|\${PROJECT_ID}|${{ env.PROJECT_ID }}|g" \
              -e "s|\${IMAGE}|${IMAGE}|g" \
              cloudrun/admin.yaml > /tmp/admin-deploy.yaml
          echo "=== Rendered Admin YAML ==="
          cat /tmp/admin-deploy.yaml

      - name: 'Deploy Admin'
        run: |-
          gcloud run services replace /tmp/admin-deploy.yaml \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"

      - name: 'Allow Unauthenticated Access to Admin'
        run: |-
          gcloud run services add-iam-policy-binding wydot-admin \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --member="allUsers" \
            --role="roles/run.invoker"
