name: WYDOT Ingestion Service Deployment

on:
  push:
    branches: [ main ]
    paths:
      - "ingestion_service/**"
      - "cloudrun/ingestion.yaml"
      - ".github/workflows/deploy-ingestion.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT }}
      REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
      IMAGE: us-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/apps/wydot-ingestion:latest
      GCS_BUCKET: wydot-documents-${{ secrets.GCP_PROJECT }}

    steps:
    - uses: actions/checkout@v4

    # ðŸ” Authenticate to Google Cloud
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: github-actions-sa@${{ secrets.GCP_PROJECT }}.iam.gserviceaccount.com

    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-docker.pkg.dev --quiet

    # ðŸ“¦ Create GCS bucket if it doesn't exist
    - name: Create GCS bucket for documents
      run: |
        if ! gsutil ls gs://${GCS_BUCKET} 2>/dev/null; then
          echo "Creating bucket gs://${GCS_BUCKET}..."
          gsutil mb -l ${REGION} gs://${GCS_BUCKET}
          gsutil uniformbucketlevelaccess set on gs://${GCS_BUCKET}
        else
          echo "Bucket gs://${GCS_BUCKET} already exists"
        fi

    # ðŸ“ Create folder structure in bucket
    - name: Create folder structure
      run: |
        echo "Creating folder placeholders..."
        echo "" | gsutil cp - gs://${GCS_BUCKET}/incoming/.keep || true
        echo "" | gsutil cp - gs://${GCS_BUCKET}/processed/.keep || true
        echo "" | gsutil cp - gs://${GCS_BUCKET}/failed/.keep || true

    # ðŸ”‘ Create secrets if they don't exist
    - name: Ensure secrets exist
      run: |
        for secret in neo4j-uri neo4j-username neo4j-password; do
          if ! gcloud secrets describe $secret --project=${PROJECT_ID} 2>/dev/null; then
            echo "âš ï¸ Secret $secret does not exist. Please create it manually:"
            echo "  gcloud secrets create $secret --project=${PROJECT_ID}"
            echo "  echo -n 'YOUR_VALUE' | gcloud secrets versions add $secret --data-file=-"
          fi
        done

    # ðŸ—ï¸ Build & push image
    - name: Build & push image
      run: |
        docker build \
          -t "${IMAGE}" \
          ./ingestion_service
        docker push "${IMAGE}"

    # ðŸ“‹ Prepare YAML (inject project id)
    - name: Prepare YAML
      run: sed -e "s/\${PROJECT_ID}/${PROJECT_ID}/g" cloudrun/ingestion.yaml > /tmp/ingestion.yaml

    # ðŸš€ Deploy to Cloud Run
    - name: Deploy to Cloud Run
      run: |
        gcloud run services replace /tmp/ingestion.yaml \
          --region="${REGION}" \
          --project="${PROJECT_ID}"

    # âš¡ Create Eventarc trigger for GCS
    - name: Create Eventarc trigger
      run: |
        TRIGGER_NAME="wydot-ingestion-gcs-trigger"
        
        # Check if trigger exists
        if gcloud eventarc triggers describe ${TRIGGER_NAME} \
            --location=${REGION} \
            --project=${PROJECT_ID} 2>/dev/null; then
          echo "Trigger ${TRIGGER_NAME} already exists, updating..."
          gcloud eventarc triggers update ${TRIGGER_NAME} \
            --location=${REGION} \
            --project=${PROJECT_ID} \
            --destination-run-service=wydot-ingestion \
            --destination-run-path=/ingest
        else
          echo "Creating new trigger ${TRIGGER_NAME}..."
          gcloud eventarc triggers create ${TRIGGER_NAME} \
            --location=${REGION} \
            --project=${PROJECT_ID} \
            --destination-run-service=wydot-ingestion \
            --destination-run-region=${REGION} \
            --destination-run-path=/ingest \
            --event-filters="type=google.cloud.storage.object.v1.finalized" \
            --event-filters="bucket=${GCS_BUCKET}" \
            --service-account=cloud-run-sa@${PROJECT_ID}.iam.gserviceaccount.com
        fi

    # ðŸ“Š Output deployment info
    - name: Get service URL
      run: |
        URL=$(gcloud run services describe wydot-ingestion \
          --region=${REGION} \
          --project=${PROJECT_ID} \
          --format='value(status.url)')
        echo "ðŸš€ Ingestion service deployed at: ${URL}"
        echo "ðŸ“¦ Upload documents to: gs://${GCS_BUCKET}/incoming/"
        echo "âš¡ Files will be automatically processed via Eventarc"
